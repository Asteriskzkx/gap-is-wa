# แผนการทดสอบจัดการผู้ใช้ในระบบ (Playwright E2E Testing)

เอกสารนี้คงไว้เฉพาะกรณีที่ทดสอบได้จริงด้วย Playwright แบบ End-to-End โดยอิง UI จากหน้า `src/app/admin/user-management/page.tsx`, หน้าแก้ไข `src/app/admin/user-management/edit/[id]/page.tsx` และฟอร์มที่เกี่ยวข้องใน `src/components/form/*` / `src/components/admin/AddUserDialog.tsx`

**ขอบเขต**

- ตรวจเฉพาะสิ่งที่ผู้ใช้มองเห็น/โต้ตอบได้: ข้อความบนจอ, dialog, ปุ่ม enabled/disabled, toast, ตารางเปลี่ยนตามผลลัพธ์ที่ mock
- แนะนำให้ทำให้เทส deterministic ด้วยการ mock API ผ่าน `page.route`
- ไม่ตรวจ: สี/คลาส CSS, console log, payload/body, DB state

**API ที่เกี่ยวข้อง (แนะนำ mock ด้วย `page.route`)**

- GET `/api/v1/users?skip=...&take=...&search=...&role=...&sortField=...&sortOrder=...`
- POST `/api/v1/users`
- DELETE `/api/v1/users/:id`
- GET `/api/v1/users/normalize/:id` (หน้าแก้ไข)
- PUT `/api/v1/admins/:adminId` (Admin edit)
- PUT `/api/v1/auditors/:auditorId` (Auditor edit)
- PUT `/api/v1/committees/:committeeId` (Committee edit)
- PUT `/api/v1/farmers/:farmerId` (Farmer edit)
- PUT `/api/users/:userId` (Basic edit)

---

## การเข้าถึงหน้า

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ          | ขั้นตอนการทดสอบ                                       | ค่าคาดหวัง                                                                                      |
| ------------- | ------------------------- | ----------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| TC-001        | ต้อง login ก่อนเข้าใช้งาน | 1) เปิดหน้า `/admin/user-management` โดยไม่มี session | ระบบ redirect ไปหน้า `/`                                                                        |
| TC-002        | แสดงหัวข้อและคำอธิบายหน้า | 1) Login แล้วเปิดหน้า `/admin/user-management`        | เห็น “จัดการผู้ใช้ในระบบ” และ “จัดการข้อมูลผู้ใช้ในระบบ เช่น การเพิ่ม ลบ หรือแก้ไขข้อมูลผู้ใช้” |

---

## รายการผู้ใช้: ตัวกรอง/ตาราง

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                       | ขั้นตอนการทดสอบ                                                                 | ค่าคาดหวัง                                                                                                                                          |
| ------------- | -------------------------------------- | ------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| TC-003        | แสดงส่วนตัวกรองและปุ่มการทำงาน         | 1) เปิดหน้า                                                                     | เห็นช่องค้นหา placeholder “ค้นหาชื่อหรืออีเมล...”, dropdown placeholder “เลือก Role”, ปุ่ม tooltip “ล้างตัวกรอง”, ปุ่ม “รีเฟรช”, ปุ่ม “เพิ่มผู้ใช้” |
| TC-004        | แสดงตารางพร้อมคอลัมน์หลัก              | 1) เปิดหน้า (mock ให้มีข้อมูลอย่างน้อย 1 แถว)                                   | เห็นหัวคอลัมน์: “ID”, “Name”, “Email”, “Role”, “Create Date”                                                                                        |
| TC-005        | แสดงข้อความว่างเมื่อไม่มีผู้ใช้        | 1) mock ให้ `users=[]` และ `total=0`                                            | เห็นข้อความ “ไม่พบผู้ใช้ในระบบ.” และแสดง “แสดง 0 จาก 0 รายการ”                                                                                      |
| TC-006        | ค้นหามีสถานะ debouncing                | 1) พิมพ์ในช่องค้นหา                                                             | เห็นข้อความ “กำลังรอค้นหา...” ระหว่างรอ debounce                                                                                                    |
| TC-007        | ค้นหาแล้วตารางเปลี่ยนตามที่ mock       | 1) mock ชุดข้อมูลเริ่มต้น 2) พิมพ์คำค้นหา 3) mock response ชุดใหม่หลัง debounce | ตารางเปลี่ยนเป็นชุดข้อมูลตามที่ mock ไว้                                                                                                            |
| TC-008        | เลือก role แล้วตารางเปลี่ยนตามที่ mock | 1) เลือก Role (เช่น `ADMIN`) 2) mock response ชุดใหม่                           | ตารางเปลี่ยนเป็นชุดข้อมูลตามที่ mock ไว้                                                                                                            |
| TC-009        | กด “ล้างตัวกรอง” แล้วกลับค่าเริ่มต้น   | 1) ตั้งค่าค้นหา+Role 2) กดปุ่ม “ล้างตัวกรอง” 3) mock response ค่าเริ่มต้น       | ช่องค้นหาถูกล้าง, Role ถูกเคลียร์, ตารางกลับเป็นชุดเริ่มต้น                                                                                         |
| TC-010        | กด “รีเฟรช” แล้วดึงข้อมูลใหม่          | 1) mock response ชุดใหม่ 2) กดปุ่ม “รีเฟรช”                                     | ตารางอัปเดตตามชุดข้อมูลที่ mock ไว้                                                                                                                 |
| TC-011        | Pagination: เปลี่ยนจำนวนรายการต่อหน้า  | 1) เปลี่ยน rows เป็น 25 (mock ให้ชุดข้อมูลต่างจาก 10)                           | ตารางอัปเดตตามชุดข้อมูลที่ mock ไว้                                                                                                                 |
| TC-012        | Sorting: คลิกหัวคอลัมน์ให้ลำดับเปลี่ยน | 1) คลิกหัวคอลัมน์ (เช่น “Create Date”) 2) mock ให้ response ต่างกัน             | ตารางเปลี่ยนลำดับตามที่ mock ไว้                                                                                                                    |

---

## เพิ่มผู้ใช้ใหม่ (Dialog “เพิ่มผู้ใช้ใหม่”)

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                       | ขั้นตอนการทดสอบ                                                                                                   | ค่าคาดหวัง                                                                         |
| ------------- | -------------------------------------- | ----------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| TC-013        | เปิด dialog เพิ่มผู้ใช้ได้             | 1) กดปุ่ม “เพิ่มผู้ใช้”                                                                                           | เห็น dialog หัวข้อ “เพิ่มผู้ใช้ใหม่” และ dropdown placeholder “เลือกบทบาท (Role)”  |
| TC-014        | ปุ่ม “บันทึก” disabled เมื่อกรอกไม่ครบ | 1) เปิด dialog โดยยังไม่เลือก Role/ไม่กรอกข้อมูล                                                                  | ปุ่ม “บันทึก” disabled                                                             |
| TC-015        | สร้างผู้ใช้สำเร็จ (กรณี role=ADMIN)    | 1) เลือก Role = `ADMIN` 2) กรอก คำนำหน้า/ชื่อ/นามสกุล/อีเมล 3) mock POST `/api/v1/users` ให้สำเร็จ 4) กด “บันทึก” | เห็น toast “สร้างผู้ใช้สำเร็จ” และ dialog ปิดลง (และตาราง refresh ตามที่ mock ไว้) |
| TC-016        | สร้างผู้ใช้ไม่สำเร็จ (API ตอบ error)   | 1) กรอกข้อมูลครบ 2) mock POST ให้ error 3) กด “บันทึก”                                                            | เห็น toast “สร้างผู้ใช้ไม่สำเร็จ” และ dialog ยังเปิดอยู่                           |
| TC-017        | ปิด dialog ด้วยปุ่ม “ยกเลิก”           | 1) เปิด dialog 2) กด “ยกเลิก”                                                                                     | dialog ปิดลง                                                                       |

---

## เมนูต่อแถว (Edit/Delete) และการลบผู้ใช้

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                          | ขั้นตอนการทดสอบ                                                        | ค่าคาดหวัง                                                                                             |
| ------------- | ----------------------------------------- | ---------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| TC-018        | เปิดเมนูต่อแถวและเห็นตัวเลือก Edit/Delete | 1) mock ให้มีผู้ใช้อย่างน้อย 1 แถว 2) กดปุ่มจุดสามจุดในแถวนั้น         | เห็นเมนูรายการ “Edit” และ “Delete”                                                                     |
| TC-019        | กด Delete แล้วเห็น dialog ยืนยันการลบ     | 1) เปิดเมนู 2) กด “Delete”                                             | เห็น dialog หัวข้อ “ยืนยันการลบ” และข้อความ “ต้องการลบผู้ใช้ชื่อ : … ใช่ไหม?” พร้อมปุ่ม “ยกเลิก”, “ลบ” |
| TC-020        | ยกเลิกลบแล้ว dialog ปิดลง                 | 1) เปิด dialog ยืนยันการลบ 2) กด “ยกเลิก”                              | dialog ปิดลง                                                                                           |
| TC-021        | ลบผู้ใช้สำเร็จ                            | 1) เปิด dialog 2) mock DELETE `/api/v1/users/:id` ให้สำเร็จ 3) กด “ลบ” | เห็น toast “ลบผู้ใช้สำเร็จ” และตาราง refresh ตามที่ mock ไว้                                           |
| TC-022        | ลบผู้ใช้ไม่สำเร็จ (API ตอบ error)         | 1) เปิด dialog 2) mock DELETE ให้ error 3) กด “ลบ”                     | เห็น toast “ลบผู้ใช้ไม่สำเร็จ”                                                                         |

---

## หน้าแก้ไขผู้ใช้ (`/admin/user-management/edit/:id`)

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                              | ขั้นตอนการทดสอบ                                                                                          | ค่าคาดหวัง                                                                                                                        |
| ------------- | --------------------------------------------- | -------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| TC-023        | ไม่พบผู้ใช้ (User not found)                  | 1) เปิด `/admin/user-management/edit/999` 2) mock GET `/api/v1/users/normalize/999` ให้ตอบ 404           | เห็นข้อความ “User not found.”                                                                                                     |
| TC-024        | แสดงฟอร์มแก้ไขตาม role=ADMIN                  | 1) เปิด `/admin/user-management/edit/:id` 2) mock normalize ให้เป็นผู้ใช้ role `ADMIN` พร้อมข้อมูล admin | เห็นหัวข้อ “แก้ไขข้อมูลของ ผู้ดูแลระบบ” และมีฟิลด์ “คำนำหน้า/ชื่อ/นามสกุล/อีเมล” พร้อมปุ่ม “บันทึก”, “รีเซ็ต”                     |
| TC-025        | ปุ่ม “บันทึก” disabled เมื่อยังไม่แก้ไขข้อมูล | 1) เปิดฟอร์มโดยยังไม่เปลี่ยนค่าใด ๆ                                                                      | ปุ่ม “บันทึก” และ “รีเซ็ต” disabled                                                                                               |
| TC-026        | บันทึกสำเร็จ (Admin edit)                     | 1) เปลี่ยนค่าอย่างน้อย 1 ฟิลด์ 2) mock PUT `/api/v1/admins/:adminId` ให้สำเร็จ 3) กด “บันทึก”            | เห็น toast (summary “สำเร็จ”) และ detail “บันทึกข้อมูลผู้ดูแลระบบเรียบร้อย”                                                       |
| TC-027        | บันทึกไม่สำเร็จ (Admin edit)                  | 1) เปลี่ยนค่า 2) mock PUT ให้ error พร้อม message (หรือให้ res ไม่ ok) 3) กด “บันทึก”                    | เห็น toast (summary “ไม่สำเร็จ”) และ detail เป็น “บันทึกข้อมูลผู้ดูแลระบบไม่สำเร็จ” หรือข้อความ error จาก backend ตามที่ mock ไว้ |
| TC-028        | รีเซ็ตค่ากลับค่าเริ่มต้น                      | 1) เปลี่ยนค่าอย่างน้อย 1 ฟิลด์ 2) กด “รีเซ็ต”                                                            | ค่าในฟิลด์กลับเป็นค่าเริ่มต้น และปุ่มกลับเป็น disabled                                                                            |
