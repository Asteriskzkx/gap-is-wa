# แผนการทดสอบการขอยกเลิกใบรับรอง (Playwright E2E Testing)

**รวม 32 Test Cases (เฉพาะเคสที่ทำ E2E ด้วย Playwright ได้จริง)**

> หน้าเป้าหมาย: `/farmer/applications/cancel` (ไฟล์ `src/app/farmer/applications/cancel/page.tsx`)
>
> แนวทางการคัดเลือกเคส:
>
> - เน้นสิ่งที่ผู้ใช้เห็น/กดได้จริง และตรวจได้จาก DOM/Navigation/Toast
> - ตัดเคสตรวจ implementation ภายใน เช่น ตรวจ query string ลึก ๆ, ตรวจ DB, ตรวจ CSS class/spacing/color
> - กรณี API/เงื่อนไขข้อมูล ควรทำผ่าน seed data หรือ mock network ใน Playwright (`page.route`)

## 1. การเข้าถึงหน้าและการแสดงผลพื้นฐาน

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                  | ขั้นตอนการทดสอบ                                                   | ข้อมูลการทดสอบ | ค่าคาดหวัง                                                                                                      |
| ------------- | --------------------------------- | ----------------------------------------------------------------- | -------------- | --------------------------------------------------------------------------------------------------------------- |
| TC-001        | ไม่ได้ login แล้วเข้าหน้า cancel  | 1. ไม่ได้ login<br>2. เปิดหน้า `/farmer/applications/cancel`      | ไม่มี session  | ระบบ redirect ไปหน้า `/`                                                                                        |
| TC-002        | แสดงหัวข้อ/คำอธิบาย/StepIndicator | 1. Login เป็นเกษตรกร<br>2. เปิดหน้า `/farmer/applications/cancel` | มี session     | เห็นหัวข้อ “ขอยกเลิกใบรับรองแหล่งผลิต”, subtitle และ StepIndicator 2 ขั้น (“เลือกใบรับรอง”, “ขอยกเลิกใบรับรอง”) |
| TC-003        | ค่าเริ่มต้นอยู่ Step 1            | 1. Login เป็นเกษตรกร<br>2. เปิดหน้า `/farmer/applications/cancel` | มี session     | เห็นตัวกรองวันที่ + ปุ่ม “ค้นหา/ล้างค่า” + ปุ่มแท็บ 2 ปุ่ม และยังไม่เห็นฟอร์ม textarea ของ Step 2               |

## 2. Step 1: ตัวกรอง + แท็บ + ตารางรายการ

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                                | ขั้นตอนการทดสอบ                                                                     | ข้อมูลการทดสอบ                           | ค่าคาดหวัง                                                                                                                     |
| ------------- | ----------------------------------------------- | ----------------------------------------------------------------------------------- | ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| TC-004        | แสดง loading ระหว่างดึงข้อมูล                   | 1. เปิดหน้า Step 1                                                                  | API ตอบช้า                               | DataTable แสดงสถานะ loading (เช่น spinner/overlay)                                                                             |
| TC-005        | ไม่มีรายการใบรับรอง                             | 1. Login เป็นเกษตรกร<br>2. เปิดหน้า Step 1                                          | API ส่ง results ว่าง                     | แสดงตารางว่าง/empty state และไม่ crash                                                                                         |
| TC-006        | แสดงคอลัมน์หลักครบถ้วน (แท็บ “ใบรับรองทั้งหมด”) | 1. อยู่ Step 1 (แท็บ “ใบรับรองทั้งหมด”)<br>2. ตรวจสอบหัวคอลัมน์                     | มีข้อมูล                                 | มีคอลัมน์: “รหัสใบรับรอง”, “รหัสการตรวจ”, “วันที่ตรวจ”, “สถานที่”, “วันที่มีผล”, “วันที่หมดอายุ” และคอลัมน์ Actions (ปุ่ม eye) |
| TC-007        | แสดง “-” เมื่อไม่มีข้อมูล inspection            | 1. อยู่ Step 1<br>2. ดูแถวที่ `inspection` เป็น null                                | มีข้อมูลบางแถว inspection=null           | คอลัมน์ “รหัสการตรวจ/วันที่ตรวจ/สถานที่” แสดง “-”                                                                              |
| TC-008        | กด “ค้นหา” หลังเลือกวันที่                      | 1. เลือกวันที่ใน “วันที่มีผล (จาก)” และ/หรือ “วันที่หมดอายุ (ถึง)”<br>2. กด “ค้นหา” | มีข้อมูล                                 | ตาราง refresh ตามตัวกรอง (ยืนยันจากจำนวน/รายการที่เปลี่ยน)                                                                     |
| TC-009        | กด “ล้างค่า” รีเซ็ตตัวกรอง                      | 1. เลือก fromDate/toDate<br>2. กด “ล้างค่า”                                         | มีค่าตัวกรองอยู่                         | calendar ถูกล้าง และตาราง refresh กลับสภาพไม่กรอง                                                                              |
| TC-010        | เปลี่ยนแท็บเป็น “ใบรับรองที่ขอยกเลิก”           | 1. อยู่ Step 1<br>2. กดปุ่ม “ใบรับรองที่ขอยกเลิก”                                   | มีใบรับรองที่ cancelRequestFlag=true     | ตารางแสดงผลของแท็บนี้ และคอลัมน์ท้ายเป็น “สถานะ” (ไม่มี Actions)                                                               |
| TC-011        | แสดงสถานะ “ยื่นขอยกเลิกแล้ว”                    | 1. อยู่แท็บ “ใบรับรองที่ขอยกเลิก”                                                   | cancelRequestFlag=true, activeFlag=true  | คอลัมน์สถานะแสดง “ยื่นขอยกเลิกแล้ว”                                                                                            |
| TC-012        | แสดงสถานะ “ยกเลิกใบรับรองแล้ว”                  | 1. อยู่แท็บ “ใบรับรองที่ขอยกเลิก”                                                   | cancelRequestFlag=true, activeFlag=false | คอลัมน์สถานะแสดง “ยกเลิกใบรับรองแล้ว”                                                                                          |
| TC-013        | แท็บ “ใบรับรองที่ขอยกเลิก” ไม่มีปุ่ม “ถัดไป”    | 1. อยู่แท็บ “ใบรับรองที่ขอยกเลิก”                                                   | -                                        | ไม่แสดงปุ่ม “ถัดไป”                                                                                                            |
| TC-014        | เปลี่ยนกลับแท็บ “ใบรับรองทั้งหมด”               | 1. จากแท็บ “ใบรับรองที่ขอยกเลิก” กด “ใบรับรองทั้งหมด”                               | -                                        | กลับมาเห็นคอลัมน์ Actions และมีปุ่ม “ถัดไป”                                                                                    |

## 3. Step 1: การเลือกแถว / Pagination / Sorting

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                          | ขั้นตอนการทดสอบ                                                       | ข้อมูลการทดสอบ   | ค่าคาดหวัง                                                                |
| ------------- | ----------------------------------------- | --------------------------------------------------------------------- | ---------------- | ------------------------------------------------------------------------- |
| TC-015        | ไม่เลือกใบรับรองแล้วปุ่ม “ถัดไป” disabled | 1. อยู่แท็บ “ใบรับรองทั้งหมด”<br>2. ไม่เลือกแถว                       | มีข้อมูล         | ปุ่ม “ถัดไป” disabled                                                     |
| TC-016        | เลือกใบรับรองโดยคลิกที่แถว                | 1. คลิกแถวใบรับรอง 1 แถว                                              | มีข้อมูล         | ปุ่ม “ถัดไป” enabled                                                      |
| TC-017        | เลือกใบรับรองอื่นแทน                      | 1. เลือกแถว A<br>2. เลือกแถว B                                        | มีข้อมูล         | selection เปลี่ยนไปเป็นแถว B และ “ถัดไป” ยัง enabled                      |
| TC-018        | เปลี่ยนจำนวนรายการต่อหน้า                 | 1. อยู่ Step 1<br>2. เปลี่ยน rows เป็น 25 หรือ 50                     | มีข้อมูลมากพอ    | ตารางแสดงจำนวนรายการต่อหน้าตามที่เลือก                                    |
| TC-019        | เปลี่ยนหน้า pagination                    | 1. อยู่ Step 1<br>2. ไปหน้าถัดไปจาก paginator                         | มีข้อมูลหลายหน้า | ตารางเปลี่ยนรายการตามหน้าที่เลือก                                         |
| TC-020        | Sorting ตาม “รหัสใบรับรอง”                | 1. คลิกหัวคอลัมน์ “รหัสใบรับรอง” 1 ครั้ง<br>2. คลิกอีกครั้ง           | มีข้อมูลหลายแถว  | ลำดับรายการเปลี่ยนตามการ sort (ตรวจจากค่าบรรทัดบนสุด/ชุดข้อมูลที่เปลี่ยน) |
| TC-021        | เปลี่ยนแท็บแล้ว selection ถูกล้าง         | 1. อยู่แท็บ “ใบรับรองทั้งหมด”<br>2. เลือกแถว<br>3. เปลี่ยนแท็บไป/กลับ | มีข้อมูล         | กลับมาที่แท็บเดิมแล้วปุ่ม “ถัดไป” disabled (เพราะ selection ถูกล้าง)      |

## 4. Step 1: ดูไฟล์ใบรับรอง (Actions)

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ           | ขั้นตอนการทดสอบ                                                 | ข้อมูลการทดสอบ               | ค่าคาดหวัง                                                |
| ------------- | -------------------------- | --------------------------------------------------------------- | ---------------------------- | --------------------------------------------------------- |
| TC-022        | กดปุ่ม eye แล้วเปิดไฟล์ได้ | 1. อยู่แท็บ “ใบรับรองทั้งหมด”<br>2. กดปุ่ม eye ของแถวใดแถวหนึ่ง | API ส่ง files[0].url ถูกต้อง | เปิดไฟล์ในแท็บใหม่ (หรือยืนยันว่า `window.open` ถูกเรียก) |
| TC-023        | กดปุ่ม eye แต่ไม่มีไฟล์    | 1. กดปุ่ม eye ของใบรับรองที่ไม่มีไฟล์                           | API ส่ง files=[]             | แสดง toast error “ไม่พบไฟล์สำหรับใบรับรองนี้”             |
| TC-024        | กดปุ่ม eye แล้ว API error  | 1. กดปุ่ม eye<br>2. ทำให้ API `/api/v1/files/get-files` error   | API error                    | แสดง toast error “เกิดข้อผิดพลาดขณะดึงไฟล์”               |

## 5. Step 2: ฟอร์มขอยกเลิกใบรับรอง

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                                    | ขั้นตอนการทดสอบ                                                                                                         | ข้อมูลการทดสอบ            | ค่าคาดหวัง                                                                                           |
| ------------- | --------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- | ------------------------- | ---------------------------------------------------------------------------------------------------- |
| TC-025        | ไป Step 2 ได้เมื่อเลือกใบรับรอง                     | 1. อยู่แท็บ “ใบรับรองทั้งหมด”<br>2. เลือกแถว<br>3. กด “ถัดไป”                                                           | มีข้อมูล                  | ไป Step 2 และเห็น label “รายละเอียดคำขอยกเลิกใบรับรอง” + textarea                                    |
| TC-026        | แสดงค่า prefill จาก `cancelRequestDetail`           | 1. เลือกใบรับรองที่มี `cancelRequestDetail` เดิม<br>2. กด “ถัดไป”                                                       | cancelRequestDetail มีค่า | textarea ถูก prefill ตามข้อมูลเดิม                                                                   |
| TC-027        | ปุ่ม “บันทึกคำขอยกเลิก” disabled เมื่อว่าง          | 1. เข้า Step 2<br>2. ทำ textarea ว่าง                                                                                   | cancelRequestDetail = ""  | ปุ่ม “บันทึกคำขอยกเลิก” disabled                                                                     |
| TC-028        | ปุ่ม “บันทึกคำขอยกเลิก” disabled เมื่อมีแต่ช่องว่าง | 1. เข้า Step 2<br>2. กรอกเฉพาะ whitespace                                                                               | " "                       | ปุ่ม “บันทึกคำขอยกเลิก” disabled                                                                     |
| TC-029        | จำกัดความยาว 255 ตัวอักษร                           | 1. เข้า Step 2<br>2. กรอกข้อความยาวเกิน 255 ตัวอักษร                                                                    | 300 chars                 | ค่าใน textarea ถูกจำกัดไว้ไม่เกิน 255                                                                |
| TC-030        | บันทึกสำเร็จ                                        | 1. เข้า Step 2<br>2. กรอกข้อความ<br>3. กด “บันทึกคำขอยกเลิก”                                                            | API ตอบสำเร็จ             | แสดง toast success “บันทึกคำขอยกเลิกเรียบร้อยแล้ว” และกลับ Step 1 พร้อมล้าง selection และล้างข้อความ |
| TC-031        | บันทึกล้มเหลว (API error)                           | 1. เข้า Step 2<br>2. กรอกข้อความ<br>3. ทำให้ API `/api/v1/certificates/edit-cancel-request-detail` error<br>4. กดบันทึก | API error                 | แสดง toast error “เกิดข้อผิดพลาดขณะบันทึกคำขอยกเลิก” และยังคงอยู่ Step 2 (ข้อความยังไม่ถูกล้าง)      |
| TC-032        | หลังบันทึกสำเร็จ ปุ่ม “ถัดไป” กลับมา disabled       | 1. ทำ TC-031 ให้สำเร็จ                                                                                                  | -                         | อยู่ Step 1 แล้วปุ่ม “ถัดไป” disabled จนกว่าจะเลือกแถวใหม่                                           |
