# แผนการทดสอบการออกใบรับรองแหล่งผลิตจีเอพี (Playwright E2E Testing)

เอกสารนี้คงไว้เฉพาะกรณีทดสอบที่ทำ E2E ด้วย Playwright ได้จริง โดยยึดพฤติกรรมที่ผู้ใช้เห็นในหน้า “ออกใบรับรองแหล่งผลิตจีเอพี” เท่านั้น

## ขอบเขต

### In-scope (ทำได้ด้วย E2E)

- หน้าและหัวข้อ: “ออกใบรับรองแหล่งผลิตจีเอพี” + subtitle
- Step 1: ตัวกรองวันที่ (ตั้งแต่/ถึง) + ปุ่ม “ค้นหา/ล้างค่า”, ตารางรายการ, pagination, sort แบบ UI, เลือกแถว, ปุ่ม “ถัดไป”
- Step 2: ฟอร์มออกใบรับรอง (วันที่มีผล/วันที่หมดอายุ), อัปโหลดไฟล์ PDF, ปุ่ม “ย้อนกลับ/ออกใบรับรอง”, validation/error message บนหน้า
- เส้นทางสถานะ: unauthenticated → redirect ไป “/”

### Out-of-scope (ไม่ใช่ E2E หรือไม่เสถียร)

- ตรวจสอบ payload/body ที่ส่งไป API, ตรวจ state ภายใน (issuedId/submitting), ตรวจ console log
- ตรวจเงื่อนไข “พร้อมออกใบรับรอง” แบบตรรกะฝั่ง backend (ยืนยันจาก UI เท่านั้น)
- ตรวจข้อความ empty state ที่ไม่ได้กำหนดชัดในหน้า (ขึ้นกับคอมโพเนนต์ตาราง)
- ตรวจ responsive/layout/pixel-perfect

## เงื่อนไขก่อนทดสอบ

- Login เป็น Committee สำเร็จ
- มีข้อมูล inspection “พร้อมออกใบรับรอง” อย่างน้อย 2 รายการ เพื่อทดสอบการเปลี่ยนแถว
- สำหรับกรณี success/error แนะนำให้ mock API:
  - `GET /api/v1/inspections/ready-to-issue`
  - `POST /api/v1/certificates/issue`

## Step 0 — การเข้าถึงระบบ

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ        | ขั้นตอนการทดสอบ                        | ข้อมูลการทดสอบ | ค่าคาดหวัง          |
| ------------- | ----------------------- | -------------------------------------- | -------------- | ------------------- |
| TC-001        | ไม่ได้ login → redirect | 1) เปิดหน้าออกใบรับรองโดยไม่มี session | ไม่ล็อกอิน     | ถูก redirect ไป “/” |

## Step 1 — เลือกการตรวจ (ตาราง + ตัวกรอง)

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                              | ขั้นตอนการทดสอบ                                                      | ข้อมูลการทดสอบ                                   | ค่าคาดหวัง                                                                                              |
| ------------- | --------------------------------------------- | -------------------------------------------------------------------- | ------------------------------------------------ | ------------------------------------------------------------------------------------------------------- |
| TC-002        | แสดงชื่อหน้า + subtitle                       | 1) เข้าหน้า “ออกใบรับรองแหล่งผลิตจีเอพี”                             | ล็อกอิน Committee                               | เห็นหัวข้อ “ออกใบรับรองแหล่งผลิตจีเอพี” และ subtitle “ออกใบรับรองแหล่งผลิตยางพาราที่ผ่านการตรวจประเมิน” |
| TC-003        | แสดง StepIndicator 2 ขั้น (Step 1 active)     | 1) อยู่ Step 1                                                       | อยู่หน้า Step 1                                | เห็นข้อความ “ขั้นตอนที่ 1” และ label “เลือกการตรวจ” ใน StepIndicator                                    |
| TC-004        | ตารางแสดงสถานะ loading                        | 1) เข้า Step 1 ขณะโหลดรายการ                                         | หน่วง response ~1.2s (GET ready-to-issue)       | ตารางแสดงสถานะ loading แล้วจึงแสดงข้อมูล                                                                |
| TC-005        | ตารางมีหัวคอลัมน์ครบ                          | 1) รอโหลดเสร็จ 2) ตรวจหัวคอลัมน์                                     | มีข้อมูลอย่างน้อย 1 แถว                         | พบหัวคอลัมน์: “รหัสการตรวจ”, “วันที่ตรวจ”, “สถานที่”, “เกษตรกร”, “หัวหน้าผู้ตรวจประเมิน”                |
| TC-006        | ปุ่ม “ถัดไป” disabled เมื่อยังไม่เลือกแถว     | 1) ไม่เลือกแถวใด ๆ                                                   | ยังไม่เลือกแถว                                  | ปุ่ม “ถัดไป” disabled                                                                                   |
| TC-007        | เลือกแถวแล้ว highlight + ปุ่ม “ถัดไป” enabled | 1) คลิกเลือกแถวในตาราง                                               | มีข้อมูลอย่างน้อย 1 แถว                         | แถวถูก highlight (bg-green-50) และปุ่ม “ถัดไป” enabled                                                  |
| TC-008        | เลือกแถวใหม่แทนที่แถวเดิม                     | 1) คลิกเลือกแถว A 2) คลิกเลือกแถว B                                  | มีข้อมูลอย่างน้อย 2 แถว                         | แถว B ถูก highlight และแถว A ไม่ highlight                                                              |
| TC-009        | เปลี่ยนหน้า (pagination)                      | 1) มีข้อมูลหลายหน้า 2) เปลี่ยนหน้าใน paginator                       | มีมากกว่า 1 หน้า                                 | รายการในตารางเปลี่ยนตามหน้าที่เลือก                                                                     |
| TC-010        | เปลี่ยนจำนวนรายการต่อหน้า                     | 1) เปลี่ยน rows เป็น 25 หรือ 50                                      | เลือก 25                                        | จำนวนรายการที่แสดงต่อหน้าเปลี่ยนตามที่เลือก                                                             |
| TC-011        | Sort ขั้นพื้นฐานจาก UI                        | 1) คลิกหัวคอลัมน์ที่ sortable (เช่น “รหัสการตรวจ” หรือ “วันที่ตรวจ”) | คอลัมน์ sortable                                | UI แสดงสถานะ sort และลำดับรายการในตารางเปลี่ยน (ยืนยันจาก UI)                                           |

### ตัวกรองวันที่ (IssueFilter)

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ              | ขั้นตอนการทดสอบ                                             | ข้อมูลการทดสอบ                         | ค่าคาดหวัง                                                                                         |
| ------------- | ----------------------------- | ----------------------------------------------------------- | -------------------------------------- | -------------------------------------------------------------------------------------------------- |
| TC-012        | แสดงตัวกรอง “ตั้งแต่/ถึง”     | 1) อยู่ Step 1                                              | อยู่หน้า Step 1                        | เห็น label “ตั้งแต่” (placeholder “เลือกวันที่เริ่ม”) และ “ถึง” (placeholder “เลือกวันที่สิ้นสุด”) |
| TC-013        | กด “ค้นหา” แล้วรีเฟรชตาราง    | 1) เลือกวันที่ตั้งแต่/ถึง (อย่างใดอย่างหนึ่ง) 2) กด “ค้นหา” | เลือกวันที่เริ่มอย่างน้อย 1 ค่า        | ตารางแสดง loading แล้วรีเฟรชรายการ                                                                 |
| TC-014        | กด “ล้างค่า” แล้วรีเซ็ตวันที่ | 1) เลือกวันที่ตั้งแต่/ถึง 2) กด “ล้างค่า”                   | มีค่าวันที่เริ่มก่อนกดล้างค่า          | ช่องวันที่ทั้งสองถูกล้าง และตารางรีเฟรช                                                            |

## Step 2 — ออกใบรับรอง (IssuancePanel)

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                                | ขั้นตอนการทดสอบ                                                                               | ข้อมูลการทดสอบ                                   | ค่าคาดหวัง                                                                             |
| ------------- | ----------------------------------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------ | -------------------------------------------------------------------------------------- |
| TC-015        | ไป Step 2 ได้เมื่อเลือกแถว                      | 1) เลือกแถว 2) กด “ถัดไป”                                                                     | เลือกแถวแรกของตาราง                             | เห็นข้อความ “การออกใบรับรองสำหรับ: {inspectionNo}” และ “สถานที่: {villageName หรือ -}” |
| TC-016        | แสดงฟิลด์ “วันที่มีผล/วันที่หมดอายุ”            | 1) อยู่ Step 2                                                                                | อยู่ Step 2                                      | เห็น label “วันที่มีผล” และ “วันที่หมดอายุ”                                            |
| TC-017        | แสดงส่วนอัปโหลดไฟล์ใบรับรอง                     | 1) อยู่ Step 2                                                                                | อยู่ Step 2                                      | เห็น label “ไฟล์ใบรับรอง (PDF) จำนวน 1 ไฟล์” และปุ่มเลือกไฟล์ “เลือกไฟล์”              |
| TC-018        | คลิก “ย้อนกลับ” กลับ Step 1 (ยังคงการเลือกเดิม) | 1) อยู่ Step 2 2) กด “ย้อนกลับ”                                                               | เคยเลือกแถวไว้ก่อนกด “ย้อนกลับ”                 | กลับ Step 1 และแถวที่เคยเลือกยัง highlight / ปุ่ม “ถัดไป” ยัง enabled                  |
| TC-019        | เปลี่ยน inspection แล้วฟอร์มรีเซ็ต              | 1) Step 2: เลือกวันที่บางค่า 2) ย้อนกลับไป Step 1 3) เลือก inspection คนละรายการ 4) ไป Step 2 | มีอย่างน้อย 2 แถว, เลือกวันที่แล้วเปลี่ยนแถว   | ค่า “วันที่มีผล/วันที่หมดอายุ” ถูกรีเซ็ตเป็นว่าง และ error message หายไป               |

### Validation/Error ที่ยืนยันด้วยข้อความบนหน้า

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                        | ขั้นตอนการทดสอบ                                                                                | ข้อมูลการทดสอบ                                      | ค่าคาดหวัง                                                 |
| ------------- | --------------------------------------- | ---------------------------------------------------------------------------------------------- | --------------------------------------------------- | ---------------------------------------------------------- |
| TC-020        | ไม่เลือกวันที่มีผล                      | 1) อยู่ Step 2 2) ไม่เลือก “วันที่มีผล” 3) กด “ออกใบรับรอง”                                    | ไม่เลือกวันที่มีผล                                  | แสดง error “กรุณาเลือกวันที่มีผล”                          |
| TC-021        | เลือกวันที่มีผลแต่ไม่เลือกวันที่หมดอายุ | 1) เลือก “วันที่มีผล” 2) ไม่เลือก “วันที่หมดอายุ” 3) กด “ออกใบรับรอง”                          | เลือกวันที่มีผลอย่างเดียว                            | แสดง error “กรุณาเลือกวันที่หมดอายุ”                       |
| TC-022        | วันหมดอายุก่อนวันมีผล                   | 1) เลือก “วันที่มีผล” เป็นวันหลัง 2) เลือก “วันที่หมดอายุ” เป็นวันก่อนหน้า 3) กด “ออกใบรับรอง” | วันที่หมดอายุก่อนวันมีผล                            | แสดง error “วันที่หมดอายุต้องมากกว่าหรือเท่ากับวันที่มีผล” |
| TC-023        | วันหมดอายุเกิน 2 ปีจากวันมีผล           | 1) เลือก “วันที่มีผล” 2) เลือก “วันที่หมดอายุ” ให้มากกว่า 2 ปี 3) กด “ออกใบรับรอง”             | วันที่หมดอายุ > 2 ปีจากวันที่มีผล                   | แสดง error “วันที่หมดอายุต้องไม่เกิน 2 ปีจากวันที่มีผล”    |

### การเรียก API ออกใบรับรอง (ควร mock)

| รหัสกรณีทดสอบ | ชื่อกรณีการทดสอบ                           | ขั้นตอนการทดสอบ                                                                                                   | ข้อมูลการทดสอบ                                             | ค่าคาดหวัง                                                                                                                       |
| ------------- | ------------------------------------------ | ----------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| TC-024        | API error แสดงข้อความจาก server            | 1) Mock `POST /api/v1/certificates/issue` ให้ตอบ 400/500 พร้อม `{ message }` 2) กรอกวันที่ครบ 3) กด “ออกใบรับรอง” | PUT/POST 500 + message “เกิดข้อผิดพลาดจากเซิร์ฟเวอร์”     | แสดง error เป็นข้อความจาก server (ถ้าไม่มี message ให้แสดง “Failed to create certificate” หรือ “เกิดข้อผิดพลาดในการออกใบรับรอง”) |
| TC-025        | API success แต่ไม่มี certificateId/id      | 1) Mock ให้ `POST` ตอบ 200 แต่ไม่มี `certificateId` และ `id` 2) กด “ออกใบรับรอง”                                  | POST 200 แต่ body ว่าง                                     | แสดง error “Server did not return certificate id”                                                                                |
| TC-026        | ออกใบรับรองสำเร็จแล้วกลับ Step 1 และรีเซ็ต | 1) Mock `POST` ตอบ 200 พร้อม `certificateId` หรือ `id` 2) กรอกวันที่ครบ 3) กด “ออกใบรับรอง” 4) รอ ~800ms          | POST 200 + `certificateId`                                 | กลับ Step 1, selection ถูกรีเซ็ต (ปุ่ม “ถัดไป” disabled) และ pagination ถูก reset ไปหน้าแรก                                      |
